on: [push]

name: tests

jobs:
  install:
    name: Install dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install

  typecheck:
    name: Run typecheck
    runs-on: ubuntu-latest
    needs: [install]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false
      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      - name: Install dependencies
        run: pnpm install
      - run: pnpm dev && pnpm typecheck

  # lint:
  #   name: Run lint
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && pnpm lint

  # build:
  #   name: Run build
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && pnpm build

  # tests-0xsequence:
  #   name: Run 0xsequence tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/0xsequence/ && pnpm test

  # tests-abi:
  #   name: Run abi tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/abi/ && pnpm test

  # tests-api:
  #   name: Run api tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/api/ && pnpm test

  # tests-auth:
  #   name: Run auth tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/auth/ && pnpm test

  # tests-config:
  #   name: Run config tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/config/ && pnpm test

  # tests-deployer:
  #   name: Run deployer tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/deployer/ && pnpm test

  # tests-estimator:
  #   name: Run estimator tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/estimator/ && pnpm test

  # tests-guard:
  #   name: Run guard tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/guard/ && pnpm test

  # tests-indexer:
  #   name: Run indexer tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/indexer/ && pnpm test

  # tests-metadata:
  #   name: Run metadata tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/metadata/ && pnpm test

  # tests-multicall:
  #   name: Run multicall tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/multicall/ && pnpm test

  # tests-network:
  #   name: Run network tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/network/ && pnpm test

  # tests-provider:
  #   name: Run provider tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/provider/ && pnpm test

  # tests-relayer:
  #   name: Run relayer tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/relayer/ && pnpm test

  # tests-simulator:
  #   name: Run simulator tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/simulator/ && pnpm test

  # tests-transactions:
  #   name: Run transactions tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/transactions/ && pnpm test

  # tests-utils:
  #   name: Run utils tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/utils/ && pnpm test

  # tests-wallet:
  #   name: Run wallet tests
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #           ~/.cache/puppeteer
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && cd packages/wallet/ && pnpm test

  # coverage:
  #   name: Run coverage
  #   runs-on: ubuntu-latest
  #   needs: [install]
  #   steps:
  #     - uses: actions/checkout@v3
  #     - uses: actions/setup-node@v3
  #       with:
  #         node-version: 18
  #     - uses: actions/cache@v3
  #       id: pnpm-cache
  #       with:
  #         path: |
  #           node_modules
  #           */*/node_modules
  #         key: ${{ runner.os }}-install-${{ hashFiles('**/package.json', '**/pnpm.lock') }}
  #     - run: pnpm dev && (pnpm coverage || true)
  #     - uses: codecov/codecov-action@v1
  #       with:
  #         fail_ci_if_error: true
  #         verbose: true
  #         directory: ./coverage
