import { commons, v1, v2 } from '@0xsequence/core'
import { sleep } from '@0xsequence/utils'
import { GasEstimator__factory } from '@0xsequence/wallet-contracts'
import { ethers } from 'ethers'

import { FeeOption, FeeQuote, Relayer, SimulateResult } from '..'
import { FeeTokenType } from '../rpc-relayer/relayer.gen'

import * as proto from './proto.gen'

const NUMBER_OF_PREVIOUS_BLOCKS_TO_CHECK_FOR_RECEIPT = 32

const ENDORSER = '0x167ED55a57805AA50868d119Ca5E73D0b8200eEF'
const ROUTER = '0x88EA167529B7455A22e811309d9e2ED687fd1c63'

// https://eips.ethereum.org/EIPS/eip-150
const MAX_AVERAGE_CALL_DEPTH = 16
const GAS_LIMIT_TO_GAS_USAGE_RATIO = Math.pow(64 / 63, MAX_AVERAGE_CALL_DEPTH)

export class Bundler implements Relayer {
  private readonly bundler: proto.Bundler
  private readonly reader: commons.reader.Reader
  private readonly chainId: Promise<number>

  constructor(
    url: string,
    private readonly provider: ethers.providers.JsonRpcProvider
  ) {
    this.bundler = new proto.Bundler(url, fetch)
    this.reader = new commons.reader.OnChainReader(provider)
    this.chainId = provider.getNetwork().then(({ chainId }) => chainId)
  }

  simulate(wallet: string, ...transactions: commons.transaction.Transaction[]): Promise<SimulateResult[]> {
    // TODO: actually simulate
    return Promise.resolve(
      transactions.map(() => ({
        executed: true,
        succeeded: true,
        gasUsed: 100000,
        gasLimit: 250000
      }))
    )
  }

  getFeeOptions(
    address: string,
    ...transactions: commons.transaction.Transaction[]
  ): Promise<{ options: FeeOption[]; quote?: FeeQuote }> {
    throw new Error('TODO: getFeeOptions')
  }

  async getFeeOptionsRaw(
    entrypoint: string,
    data: ethers.utils.BytesLike,
    options?: {
      simulate?: boolean
    }
  ): Promise<{ options: FeeOption[]; quote?: FeeQuote }> {
    const [
      chainId,
      {
        feeAsks: { minBaseFee, minPriorityFee, acceptedTokens }
      },
      gasLimit
    ] = await Promise.all([this.chainId, this.bundler.feeAsks(), estimateGasLimit(this.provider, { to: entrypoint, data })])

    const gasPrice = ethers.BigNumber.from(minBaseFee).add(minPriorityFee)

    const feeOptions = Object.entries(acceptedTokens).map(([address, { scalingFactor, normalizationFactor }]) => {
      // TODO: unfortunately we don't reimburse the difference between gas limit and gas used
      // TODO: unfortunately we don't reimburse the difference between max fee per gas and actual fee per gas
      // TODO: estimate gas limit with the fee transaction
      // TODO: fetch fee token metadata by address
      // TODO: validate the bundler's exchange rates

      const token = {
        chainId,
        name: 'TODO',
        symbol: 'TODO',
        type: FeeTokenType.UNKNOWN,
        decimals: 0,
        logoURL: 'TODO',
        contractAddress: address
      }

      const feeGasLimit = 500000

      const fee = gasPrice.mul(gasLimit + feeGasLimit)

      return {
        token,
        to: ROUTER,
        value: fee.mul(scalingFactor).div(normalizationFactor).toString(),
        gasLimit: 250000
      }
    })

    return { options: feeOptions }
  }

  gasRefundOptions(address: string, ...transactions: commons.transaction.Transaction[]): Promise<FeeOption[]> {
    throw new Error('TODO: gasRefundOptions')
  }

  getNonce(address: string, space?: ethers.BigNumberish, blockTag?: ethers.providers.BlockTag): Promise<ethers.BigNumberish> {
    throw new Error('TODO: getNonce')
  }

  async relay(
    signedTxs: commons.transaction.IntendedTransactionBundle,
    quote?: FeeQuote,
    waitForReceipt: boolean = true
  ): Promise<commons.transaction.TransactionResponse> {
    const chainId = await this.chainId

    if (!ethers.BigNumber.from(signedTxs.chainId).eq(chainId)) {
      throw new Error(`bundler for chain ${chainId} cannot send transactions intended for chain ${signedTxs.chainId}`)
    }

    if (signedTxs.transactions.length < 1) {
      throw new Error('must send at least one transaction')
    }

    const fee = signedTxs.transactions[0]

    if (ethers.utils.getAddress(fee.to) !== ROUTER) {
      throw new Error(`fee must be paid to ${ROUTER}`)
    } else if (!fee.delegateCall) {
      throw new Error('fee transaction must delegate call')
    } else if (!fee.revertOnError) {
      throw new Error('fee transaction must revert on error')
    } else if (fee.data === undefined) {
      throw new Error('fee transaction must encode amount')
    }

    const value = ethers.utils.defaultAbiCoder.decode(['uint256'], fee.data)[0]

    const callData = commons.transaction.encodeBundleExecData(signedTxs)

    const endorserCallData = ethers.utils.defaultAbiCoder.encode(
      ['address', 'bytes32'],
      await Promise.all([this.reader.implementation(signedTxs.intent.wallet), this.reader.imageHash(signedTxs.intent.wallet)])
    )

    const gasLimit = await this.provider.estimateGas({ to: signedTxs.entrypoint, data: callData })
    const maxFeePerGas = Math.floor(ethers.BigNumber.from(value).toNumber() / gasLimit.toNumber())
    const priorityFeePerGas = 1

    await this.bundler.sendOperation({
      operation: {
        entrypoint: signedTxs.entrypoint,
        callData,
        gasLimit: gasLimit.toString(),
        feeToken: ethers.constants.AddressZero,
        endorser: ENDORSER,
        endorserCallData,
        endorserGasLimit: '1',
        maxFeePerGas: maxFeePerGas.toString(),
        priorityFeePerGas: priorityFeePerGas.toString(),
        baseFeeScalingFactor: '1',
        baseFeeNormalizationFactor: '1',
        hasUntrustedContext: false,
        chainId: signedTxs.chainId.toString()
      }
    })

    if (waitForReceipt) {
      return this.wait(signedTxs.intent.id)
    } else {
      throw new Error('TODO: relay')
    }
  }

  wait(
    metaTxnId: string | commons.transaction.SignedTransactionBundle,
    timeout?: number,
    delay: number = 1000,
    maxFails: number = 5
  ): Promise<commons.transaction.TransactionResponse> {
    const fromBlock = this.provider.blockNumber - NUMBER_OF_PREVIOUS_BLOCKS_TO_CHECK_FOR_RECEIPT

    if (typeof metaTxnId !== 'string') {
      metaTxnId = commons.transaction.intendedTransactionID(metaTxnId)
    }

    // TODO: how do we wait for v1 TxExecuted events? they are anonymous and the transaction is not indexed
    // TODO: how do we wait for v1 TxFailed events? the transaction is not indexed
    // TODO: how do we wait for reverted transactions? there might not be any TxExecuted or TxFailed events

    const filter = { fromBlock, topics: [null, metaTxnId] }

    let cancel = false

    const poll = (async () => {
      while (!cancel) {
        const logs = await this.provider.getLogs(filter)

        if (logs.length) {
          const hash = logs[0].transactionHash

          const [transaction, receipt] = await Promise.all([
            this.provider.getTransaction(hash),
            this.provider.getTransactionReceipt(hash)
          ])

          return { ...transaction, receipt }
        }

        await sleep(delay)
      }

      throw new Error(`timed out after ${timeout} ms waiting for receipt for meta transaction ${metaTxnId}`)
    })()

    if (timeout === undefined) {
      return poll
    } else {
      return Promise.race([
        poll,
        new Promise<commons.transaction.TransactionResponse>((_, reject) =>
          setTimeout(() => {
            cancel = true
            reject()
          })
        )
      ])
    }
  }
}

async function estimateGasLimit(
  provider: ethers.providers.JsonRpcProvider,
  transaction: ethers.providers.TransactionRequest
): Promise<number> {
  const { success, gas } = await estimateGasUsage(provider, transaction)
  if (!success) {
    throw new Error('execution reverted')
  }

  return Math.ceil(gas * GAS_LIMIT_TO_GAS_USAGE_RATIO)
}

async function estimateGasUsage(
  provider: ethers.providers.JsonRpcProvider,
  transaction: ethers.providers.TransactionRequest
): Promise<{ success: boolean; result: ethers.BytesLike; gas: number }> {
  const estimator = GasEstimator__factory.createInterface()
  const from = transaction.from || ethers.utils.getAddress(ethers.utils.hexlify(ethers.utils.randomBytes(20)))
  const data = estimator.encodeFunctionData('estimate', [
    transaction.to || ethers.constants.AddressZero,
    transaction.data || '0x'
  ])

  const overrides = {
    [from]: { code: GAS_ESTIMATOR_DEPLOYED_BYTECODE },
    [v1.DeployedWalletContext.mainModule]: { code: MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V1 },
    [v1.DeployedWalletContext.mainModuleUpgradable]: { code: MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V1 },
    [v2.DeployedWalletContext.mainModule]: { code: MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V2 },
    [v2.DeployedWalletContext.mainModuleUpgradable]: { code: MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V2 }
  }

  const response = await provider.send('eth_call', [{ to: from, data }, 'latest', overrides])
  const [success, result, gas] = estimator.decodeFunctionResult('estimate', response) as any
  return { success, result, gas }
}

const GAS_ESTIMATOR_DEPLOYED_BYTECODE =
  '0x608060405234801561001057600080fd5b506004361061002b5760003560e01c80630eb34cd314610030575b600080fd5b61004361003e3660046100eb565b61005b565b60405161005293929190610189565b60405180910390f35b600060606000805a90508673ffffffffffffffffffffffffffffffffffffffff16868660405161008c929190610206565b6000604051808303816000865af19150503d80600081146100c9576040519150601f19603f3d011682016040523d82523d6000602084013e6100ce565b606091505b5090945092505a6100df9082610216565b91505093509350939050565b60008060006040848603121561010057600080fd5b833573ffffffffffffffffffffffffffffffffffffffff8116811461012457600080fd5b9250602084013567ffffffffffffffff8082111561014157600080fd5b818601915086601f83011261015557600080fd5b81358181111561016457600080fd5b87602082850101111561017657600080fd5b6020830194508093505050509250925092565b831515815260006020606081840152845180606085015260005b818110156101bf578681018301518582016080015282016101a3565b5060006080828601015260807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011685010192505050826040830152949350505050565b8183823760009101908152919050565b81810381811115610250577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b9291505056fea26469706673582212206fceab4570410e5aaef6bf82e04a9e582054db6ef051e3d1376a3c3ddfe0d7e464736f6c63430008120033'
const MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V1 =
  '0x60806040526004361061012d5760003560e01c806361c2926c116100a557806390042baf11610074578063b93ea7ad11610059578063b93ea7ad14610418578063bc197c8114610438578063f23a6e611461045857610134565b806390042baf146103f0578063affed0e01461040357610134565b806361c2926c146103635780637a9a16281461038357806384dc463c146103a35780638c3f5563146103d057610134565b80631a9b2337116100fc57806329561426116100e157806329561426146103015780634fcf3eca1461032157806351605d801461034157610134565b80631a9b2337146102b457806320c13b0b146102e157610134565b806301ffc9a71461020f578063025b22bc14610245578063150b7a02146102675780631626ba7e1461029457610134565b3661013457005b60006101636000357fffffffff0000000000000000000000000000000000000000000000000000000016610478565b905073ffffffffffffffffffffffffffffffffffffffff81161561020c576000808273ffffffffffffffffffffffffffffffffffffffff166000366040518083838082843760405192019450600093509091505080830381855af49150503d80600081146101ed576040519150601f19603f3d011682016040523d82523d6000602084013e6101f2565b606091505b50915091508161020457805160208201fd5b805160208201f35b50005b34801561021b57600080fd5b5061022f61022a3660046128e0565b6104ce565b60405161023c9190612b95565b60405180910390f35b34801561025157600080fd5b506102656102603660046125d3565b6104d9565b005b34801561027357600080fd5b506102876102823660046126a4565b6105fa565b60405161023c9190612bc2565b3480156102a057600080fd5b506102876102af366004612896565b610624565b3480156102c057600080fd5b506102d46102cf3660046128e0565b61069d565b60405161023c9190612ac9565b3480156102ed57600080fd5b506102876102fc36600461292c565b6106a8565b34801561030d57600080fd5b5061026561031c36600461287e565b610702565b34801561032d57600080fd5b5061026561033c3660046128e0565b610810565b34801561034d57600080fd5b506103566108ee565b60405161023c9190612ba0565b34801561036f57600080fd5b5061026561037e3660046127c7565b61091e565b34801561038f57600080fd5b5061026561039e3660046127fa565b6109b7565b3480156103af57600080fd5b506103c36103be366004612787565b610a33565b60405161023c9190612aea565b3480156103dc57600080fd5b506103566103eb36600461287e565b610d6b565b6102d46103fe366004612995565b610d97565b34801561040f57600080fd5b50610356610e4b565b34801561042457600080fd5b506102656104333660046128fa565b610e57565b34801561044457600080fd5b506102876104533660046125ed565b610f30565b34801561046457600080fd5b50610287610473366004612711565b610f5d565b60006104c67fbe27a319efc8734e89e26ba4bc95f5c788584163b959f03fa04e2d7ab4b9a1207fffffffff000000000000000000000000000000000000000000000000000000008416610f88565b90505b919050565b60006104c682610fb5565b333014610531576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b6105508173ffffffffffffffffffffffffffffffffffffffff16611012565b6105a5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260398152602001806130b76039913960400191505060405180910390fd5b6105ae81611018565b6040805173ffffffffffffffffffffffffffffffffffffffff8316815290517f310ba5f1d2ed074b51e2eccd052a47ae9ab7c6b800d1fca3db3999d6a592ca039181900360200190a150565b7f150b7a020000000000000000000000000000000000000000000000000000000095945050505050565b600061066e6106328561101c565b84848080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061107c92505050565b1561069657507f1626ba7e000000000000000000000000000000000000000000000000000000005b9392505050565b60006104c682610478565b60006106d26106328686604051808383808284376040519201829003909120935061101c92505050565b156106fa57507f20c13b0b000000000000000000000000000000000000000000000000000000005b949350505050565b33301461075a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b806107b0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526037815260200180612ede6037913960400191505060405180910390fd5b6107da7fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf882611274565b6040805182815290517f307ed6bd941ee9fc80f369c94af5fa11e25bab5102a6140191756c5474a30bfa9181900360200190a150565b333014610868576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b600061087382610478565b73ffffffffffffffffffffffffffffffffffffffff1614156108e0576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602b815260200180612f15602b913960400191505060405180910390fd5b6108eb816000611278565b50565b60006109197fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf86112db565b905090565b333014610976576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b60006109a78260405160200161098c9190612d3d565b6040516020818303038152906040528051906020012061101c565b90506109b381836112df565b5050565b6109c0826114ae565b60006109d8838560405160200161098c929190612d84565b90506109e4818361107c565b610a23576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a1a90612ce0565b60405180910390fd5b610a2d81856112df565b50505050565b606060008267ffffffffffffffff81118015610a4e57600080fd5b50604051908082528060200260200182016040528015610a8857816020015b610a75612324565b815260200190600190039081610a6d5790505b50905060005b83811015610d63576000858583818110610aa457fe5b9050602002810190610ab69190612dab565b610abf90612e02565b905080604001515a1015610aff576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a1a90612c83565b6001838381518110610b0d57fe5b60209081029190910101519015159052805115610c105760005a9050816060015173ffffffffffffffffffffffffffffffffffffffff168260400151600014610b5a578260400151610b5c565b5a5b8360a00151604051610b6e9190612aad565b6000604051808303818686f4925050503d8060008114610baa576040519150601f19603f3d011682016040523d82523d6000602084013e610baf565b606091505b50858581518110610bbc57fe5b6020026020010151602001868681518110610bd357fe5b6020026020010151604001829052821515151581525050505a8103848481518110610bfa57fe5b6020026020010151606001818152505050610d00565b60005a9050816060015173ffffffffffffffffffffffffffffffffffffffff1682608001518360400151600014610c4b578360400151610c4d565b5a5b908460a00151604051610c609190612aad565b600060405180830381858888f193505050503d8060008114610c9e576040519150601f19603f3d011682016040523d82523d6000602084013e610ca3565b606091505b50858581518110610cb057fe5b6020026020010151602001868681518110610cc757fe5b6020026020010151604001829052821515151581525050505a8103848481518110610cee57fe5b60200260200101516060018181525050505b828281518110610d0c57fe5b602002602001015160200151158015610d4f5750858583818110610d2c57fe5b9050602002810190610d3e9190612dab565b610d4f906040810190602001612864565b15610d5a5750610d63565b50600101610a8e565b509392505050565b60006104c67f8d0bf1fd623d628c741362c1289948e57b3e2905218c676d3e69abee36d6ae2e83610f88565b6000333014610df1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b81516020830134f06040805173ffffffffffffffffffffffffffffffffffffffff8316815290519192507fa506ad4e7f05eceba62a023c3219e5bd98a615f4fa87e2afb08a2da5cf62bf0c919081900360200190a1919050565b60006109196000610d6b565b333014610eaf576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260278152602001806131d16027913960400191505060405180910390fd5b6000610eba83610478565b73ffffffffffffffffffffffffffffffffffffffff1614610f26576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180613029602c913960400191505060405180910390fd5b6109b38282611278565b7fbc197c810000000000000000000000000000000000000000000000000000000098975050505050505050565b7ff23a6e61000000000000000000000000000000000000000000000000000000009695505050505050565b60408051602080820194909452808201929092528051808303820181526060909201905280519101205490565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167f90042baf000000000000000000000000000000000000000000000000000000001415611009575060016104c9565b6104c68261155b565b3b151590565b3055565b604080517f19010000000000000000000000000000000000000000000000000000000000006020808301919091524660228301523060601b6042830152605680830194909452825180830390940184526076909101909152815191012090565b600080600061108a8461169c565b909250905061ffff821660005b855183101561125157600080806110ae898761170a565b975060ff918216945016915060018314156110d6576110cd898761178b565b965090506111fa565b826111025760606110e78a88611803565b975090506110f58b826118b4565b91508285019450506111fa565b60028314156111a957611115898761178b565b9650905060006111258a88611c3e565b975061ffff169050606061113a8b8984611caf565b985090506111498c8483611d9e565b61119e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526032815260200180612ff76032913960400191505060405180910390fd5b5050928101926111fa565b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602c815260200180612eb2602c913960400191505060405180910390fd5b848282604051602001808481526020018381526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019350505050604051602081830303815290604052805190602001209450505050611097565b8361ffff168110158015611269575061126982611fde565b979650505050505050565b9055565b6109b37fbe27a319efc8734e89e26ba4bc95f5c788584163b959f03fa04e2d7ab4b9a1207fffffffff00000000000000000000000000000000000000000000000000000000841673ffffffffffffffffffffffffffffffffffffffff8416612024565b5490565b60005b81518110156114a95760008282815181106112f957fe5b602002602001015190506000606082604001515a1015611345576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a1a90612c26565b8251156113dd57826060015173ffffffffffffffffffffffffffffffffffffffff16836040015160001461137d57836040015161137f565b5a5b8460a001516040516113919190612aad565b6000604051808303818686f4925050503d80600081146113cd576040519150601f19603f3d011682016040523d82523d6000602084013e6113d2565b606091505b509092509050611472565b826060015173ffffffffffffffffffffffffffffffffffffffff1683608001518460400151600014611413578460400151611415565b5a5b908560a001516040516114289190612aad565b600060405180830381858888f193505050503d8060008114611466576040519150601f19603f3d011682016040523d82523d6000602084013e61146b565b606091505b5090925090505b811561149357856040516114869190612ba0565b60405180910390a061149e565b61149e838783612052565b5050506001016112e2565b505050565b6000806114ba836120a2565b9150915060006114c983610d6b565b9050808214806114d7575060015b61150d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a1a90612bef565b6001820161151b84826120bb565b7f1f180c27086c7a39ea2a7b25239d1ab92348f07ca7bb59d1438fcf527568f881848260405161154c929190612d9d565b60405180910390a15050505050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167fec6aba500000000000000000000000000000000000000000000000000000000014806115ee57507fffffffff0000000000000000000000000000000000000000000000000000000082167f4e2312e000000000000000000000000000000000000000000000000000000000145b8061163a57507fffffffff0000000000000000000000000000000000000000000000000000000082167f150b7a0200000000000000000000000000000000000000000000000000000000145b8061168657507fffffffff0000000000000000000000000000000000000000000000000000000082167fc0ee0b8a00000000000000000000000000000000000000000000000000000000145b15611693575060016104c9565b6104c6826120e6565b6020810151815160f09190911c90600290811115611705576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526027815260200180612f636027913960400191505060405180910390fd5b915091565b8082016020015160f881901c9060f01c60ff166002830183811161172a57fe5b8451811115611784576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602681526020018061312c6026913960400191505060405180910390fd5b9250925092565b8082016020015160601c601482018281116117a257fe5b83518111156117fc576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526023815260200180612f406023913960400191505060405180910390fd5b9250929050565b60408051604280825260808201909252606091600091906020820181803683370190505091508284016020018051602084015260208101516040840152602281015160428401525060428301905082811161185a57fe5b83518111156117fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260238152602001806130946023913960400191505060405180910390fd5b60008151604214611910576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603a815260200180612e78603a913960400191505060405180910390fd5b60008260018451038151811061192257fe5b602001015160f81c60f81b60f81c60ff16905060008360408151811061194457fe5b016020015160f81c9050600061195a8582612143565b90506000611969866020612143565b90507f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a08111156119e4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603d815260200180612e3b603d913960400191505060405180910390fd5b8260ff16601b141580156119fc57508260ff16601c14155b15611a52576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603d815260200180612f8a603d913960400191505060405180910390fd5b6001841415611ac65760018784848460405160008152602001604052604051808581526020018460ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa158015611ab5573d6000803e3d6000fd5b505050602060405103519450611bc8565b6002841415611b775760018760405160200180807f19457468657265756d205369676e6564204d6573736167653a0a333200000000815250601c018281526020019150506040516020818303038152906040528051906020012084848460405160008152602001604052604051808581526020018460ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa158015611ab5573d6000803e3d6000fd5b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603c8152602001806130f0603c913960400191505060405180910390fd5b73ffffffffffffffffffffffffffffffffffffffff8516611c34576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526030815260200180612fc76030913960400191505060405180910390fd5b5050505092915050565b8082016020015160f01c60028201828111611c5557fe5b83518111156117fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001806131736022913960400191505060405180910390fd5b606060008267ffffffffffffffff81118015611cca57600080fd5b506040519080825280601f01601f191660200182016040528015611cf5576020820181803683370190505b509150838501602001600060205b85811015611d1c57908201518482015260208101611d03565b8486016020018051939092015190850152525082820183811015611d3c57fe5b8451811115611d96576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001806131526021913960400191505060405180910390fd5b935093915050565b60008082600184510381518110611db157fe5b016020015160f81c90506001811480611dca5750600281145b15611e0e578373ffffffffffffffffffffffffffffffffffffffff16611df086856118b4565b73ffffffffffffffffffffffffffffffffffffffff16149150610d63565b6003811415611f8d5782517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81018452604080517f1626ba7e000000000000000000000000000000000000000000000000000000008152600481018881526024820192835286516044830152865173ffffffffffffffffffffffffffffffffffffffff891693631626ba7e938b938a9390929160640190602085019080838360005b83811015611ec8578181015183820152602001611eb0565b50505050905090810190601f168015611ef55780820380516001836020036101000a031916815260200191505b50935050505060206040518083038186803b158015611f1357600080fd5b505afa158015611f27573d6000803e3d6000fd5b505050506040513d6020811015611f3d57600080fd5b50519084527fffffffff00000000000000000000000000000000000000000000000000000000167f1626ba7e00000000000000000000000000000000000000000000000000000000149150610d63565b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603f815260200180613055603f913960400191505060405180910390fd5b6000811580159061201657506120137fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf86112db565b82145b806104c65750600192915050565b6040805160208082019590955280820193909352805180840382018152606090930190528151919092012055565b82602001511561206457805160208201fd5b7f3dbd1590ea96dd3253a91f24e64e3a502e1225d602a5731357bc12643070ccd78282604051612095929190612ba9565b60405180910390a1505050565b606081901c916bffffffffffffffffffffffff90911690565b6109b37f8d0bf1fd623d628c741362c1289948e57b3e2905218c676d3e69abee36d6ae2e8383612024565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167f025b22bc00000000000000000000000000000000000000000000000000000000141561213a575060016104c9565b6104c6826121ab565b600081602001835110156121a2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603c815260200180613195603c913960400191505060405180910390fd5b50016020015190565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167f389901c70000000000000000000000000000000000000000000000000000000014156121ff575060016104c9565b6104c68260007fffffffff0000000000000000000000000000000000000000000000000000000082167f783649a6000000000000000000000000000000000000000000000000000000001415612257575060016104c9565b6104c68260007fffffffff00000000000000000000000000000000000000000000000000000000821615806122cd57507fffffffff0000000000000000000000000000000000000000000000000000000082167f36e7817500000000000000000000000000000000000000000000000000000000145b156122da575060016104c9565b7f01ffc9a7000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316146104c6565b604051806080016040528060001515815260200160001515815260200160608152602001600081525090565b803573ffffffffffffffffffffffffffffffffffffffff811681146104c957600080fd5b60008083601f840112612385578182fd5b50813567ffffffffffffffff81111561239c578182fd5b60208301915083602080830285010111156117fc57600080fd5b600082601f8301126123c6578081fd5b8135602067ffffffffffffffff8211156123dc57fe5b6123e98182840201612dde565b82815281810190858301855b8581101561241e5761240c898684358b010161252e565b845292840192908401906001016123f5565b5090979650505050505050565b803580151581146104c957600080fd5b80357fffffffff00000000000000000000000000000000000000000000000000000000811681146104c957600080fd5b60008083601f84011261247c578182fd5b50813567ffffffffffffffff811115612493578182fd5b6020830191508360208285010111156117fc57600080fd5b600082601f8301126124bb578081fd5b813567ffffffffffffffff8111156124cf57fe5b61250060207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f84011601612dde565b818152846020838601011115612514578283fd5b816020850160208301379081016020019190915292915050565b600060c0828403121561253f578081fd5b60405160c0810167ffffffffffffffff828210818311171561255d57fe5b8160405282935061256d8561242b565b835261257b6020860161242b565b60208401526040850135604084015261259660608601612350565b60608401526080850135608084015260a08501359150808211156125b957600080fd5b506125c6858286016124ab565b60a0830152505092915050565b6000602082840312156125e4578081fd5b61069682612350565b60008060008060008060008060a0898b031215612608578384fd5b61261189612350565b975061261f60208a01612350565b9650604089013567ffffffffffffffff8082111561263b578586fd5b6126478c838d01612374565b909850965060608b013591508082111561265f578586fd5b61266b8c838d01612374565b909650945060808b0135915080821115612683578384fd5b506126908b828c0161246b565b999c989b5096995094979396929594505050565b6000806000806000608086880312156126bb578081fd5b6126c486612350565b94506126d260208701612350565b935060408601359250606086013567ffffffffffffffff8111156126f4578182fd5b6127008882890161246b565b969995985093965092949392505050565b60008060008060008060a08789031215612729578182fd5b61273287612350565b955061274060208801612350565b94506040870135935060608701359250608087013567ffffffffffffffff811115612769578283fd5b61277589828a0161246b565b979a9699509497509295939492505050565b60008060208385031215612799578182fd5b823567ffffffffffffffff8111156127af578283fd5b6127bb85828601612374565b90969095509350505050565b6000602082840312156127d8578081fd5b813567ffffffffffffffff8111156127ee578182fd5b6106fa848285016123b6565b60008060006060848603121561280e578283fd5b833567ffffffffffffffff80821115612825578485fd5b612831878388016123b6565b945060208601359350604086013591508082111561284d578283fd5b5061285a868287016124ab565b9150509250925092565b600060208284031215612875578081fd5b6106968261242b565b60006020828403121561288f578081fd5b5035919050565b6000806000604084860312156128aa578081fd5b83359250602084013567ffffffffffffffff8111156128c7578182fd5b6128d38682870161246b565b9497909650939450505050565b6000602082840312156128f1578081fd5b6106968261243b565b6000806040838503121561290c578182fd5b6129158361243b565b915061292360208401612350565b90509250929050565b60008060008060408587031215612941578182fd5b843567ffffffffffffffff80821115612958578384fd5b6129648883890161246b565b9096509450602087013591508082111561297c578384fd5b506129898782880161246b565b95989497509550505050565b6000602082840312156129a6578081fd5b813567ffffffffffffffff8111156129bc578182fd5b6106fa848285016124ab565b6000815180845260208085019450848183028601828601855b8581101561241e5783830389528151805115158452858101511515868501526040808201519085015260608082015173ffffffffffffffffffffffffffffffffffffffff16908501526080808201519085015260a09081015160c091850182905290612a4f81860183612a63565b9a87019a94505050908401906001016129e1565b60008151808452612a7b816020860160208601612e0e565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b60008251612abf818460208701612e0e565b9190910192915050565b73ffffffffffffffffffffffffffffffffffffffff91909116815260200190565b60208082528251828201819052600091906040908185019080840286018301878501865b83811015612b87577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc08984030185528151608081511515855288820151151589860152878201518189870152612b6682870182612a63565b60609384015196909301959095525094870194925090860190600101612b0e565b509098975050505050505050565b901515815260200190565b90815260200190565b6000838252604060208301526106fa6040830184612a63565b7fffffffff0000000000000000000000000000000000000000000000000000000091909116815260200190565b6020808252601f908201527f4d61696e4d6f64756c65235f617574683a20494e56414c49445f4e4f4e434500604082015260600190565b60208082526024908201527f4d6f64756c6543616c6c73235f657865637574653a204e4f545f454e4f55474860408201527f5f47415300000000000000000000000000000000000000000000000000000000606082015260800190565b60208082526037908201527f4d61696e4d6f64756c65476173457374696d6174696f6e2373696d756c61746560408201527f457865637574653a204e4f545f454e4f5547485f474153000000000000000000606082015260800190565b60208082526026908201527f4d6f64756c6543616c6c7323657865637574653a20494e56414c49445f53494760408201527f4e41545552450000000000000000000000000000000000000000000000000000606082015260800190565b600060408252600560408301527f73656c663a00000000000000000000000000000000000000000000000000000060608301526080602083015261069660808301846129c8565b6000838252604060208301526106fa60408301846129c8565b918252602082015260400190565b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff41833603018112612abf578182fd5b60405181810167ffffffffffffffff81118282101715612dfa57fe5b604052919050565b60006104c6368361252e565b60005b83811015612e29578181015183820152602001612e11565b83811115610a2d575050600091015256fe5369676e617475726556616c696461746f72237265636f7665725369676e65723a20696e76616c6964207369676e6174757265202773272076616c75655369676e617475726556616c696461746f72237265636f7665725369676e65723a20696e76616c6964207369676e6174757265206c656e6774684d6f64756c6541757468235f7369676e617475726556616c69646174696f6e20494e56414c49445f464c41474d6f64756c654175746855706772616461626c6523757064617465496d6167654861736820494e56414c49445f494d4147455f484153484d6f64756c65486f6f6b732372656d6f7665486f6f6b3a20484f4f4b5f4e4f545f524547495354455245444c696242797465732372656164416464726573733a204f55545f4f465f424f554e44534c696242797465732372656164466972737455696e7431363a204f55545f4f465f424f554e44535369676e617475726556616c696461746f72237265636f7665725369676e65723a20696e76616c6964207369676e6174757265202776272076616c75655369676e617475726556616c696461746f72237265636f7665725369676e65723a20494e56414c49445f5349474e45524d6f64756c6541757468235f7369676e617475726556616c69646174696f6e3a20494e56414c49445f5349474e41545552454d6f64756c65486f6f6b7323616464486f6f6b3a20484f4f4b5f414c52454144595f524547495354455245445369676e617475726556616c696461746f7223697356616c69645369676e61747572653a20554e535550504f525445445f5349474e41545552455f545950454c696242797465732372656164427974657336363a204f55545f4f465f424f554e44534d6f64756c6555706461746523757064617465496d706c656d656e746174696f6e3a20494e56414c49445f494d504c454d454e544154494f4e5369676e617475726556616c696461746f72237265636f7665725369676e65723a20554e535550504f525445445f5349474e41545552455f545950454c69624279746573237265616455696e743855696e74383a204f55545f4f465f424f554e44534c69624279746573237265616442797465733a204f55545f4f465f424f554e44534c69624279746573237265616455696e7431363a204f55545f4f465f424f554e44534c696242797465732372656164427974657333323a20475245415445525f4f525f455155414c5f544f5f33325f4c454e4754485f52455155495245444d6f64756c6553656c6641757468236f6e6c7953656c663a204e4f545f415554484f52495a4544a26469706673582212206dbd5bca81b94cf28e33b16bade72f682aed36a30323fd37db3d338cc61aabb064736f6c63430007060033'
const MAIN_MODULE_GAS_ESTIMATION_DEPLOYED_BYTECODE_V2 =
  '0x6080604052600436106101635760003560e01c806361c2926c116100c057806390042baf11610074578063b93ea7ad11610059578063b93ea7ad1461052c578063bc197c811461054c578063f23a6e61146105945761016a565b806390042baf14610504578063affed0e0146105175761016a565b806384dc463c116100a557806384dc463c1461046f578063853c50681461049c5780638c3f5563146104e45761016a565b806361c2926c1461042f5780637a9a16281461044f5761016a565b806320c13b0b116101175780634fcf3eca116100fc5780634fcf3eca146103b857806351605d80146103d857806357c56d6b146103fb5761016a565b806320c13b0b1461037857806329561426146103985761016a565b8063150b7a0211610148578063150b7a021461029d5780631626ba7e146103135780631a9b2337146103335761016a565b806301ffc9a714610248578063025b22bc1461027d5761016a565b3661016a57005b600436106102465760006101a16000357fffffffff00000000000000000000000000000000000000000000000000000000166105da565b905073ffffffffffffffffffffffffffffffffffffffff811615610244576000808273ffffffffffffffffffffffffffffffffffffffff166000366040516101ea92919061287c565b600060405180830381855af49150503d8060008114610225576040519150601f19603f3d011682016040523d82523d6000602084013e61022a565b606091505b50915091508161023c57805160208201fd5b805160208201f35b505b005b34801561025457600080fd5b506102686102633660046128ba565b61062e565b60405190151581526020015b60405180910390f35b34801561028957600080fd5b50610246610298366004612900565b610639565b3480156102a957600080fd5b506102e26102b8366004612964565b7f150b7a020000000000000000000000000000000000000000000000000000000095945050505050565b6040517fffffffff000000000000000000000000000000000000000000000000000000009091168152602001610274565b34801561031f57600080fd5b506102e261032e3660046129d3565b61068b565b34801561033f57600080fd5b5061035361034e3660046128ba565b6106d8565b60405173ffffffffffffffffffffffffffffffffffffffff9091168152602001610274565b34801561038457600080fd5b506102e2610393366004612a1f565b6106e3565b3480156103a457600080fd5b506102466103b3366004612a8b565b610748565b3480156103c457600080fd5b506102466103d33660046128ba565b610792565b3480156103e457600080fd5b506103ed61085a565b604051908152602001610274565b34801561040757600080fd5b506103ed7f8713a7c4465f6fbee2b6e9d6646d1d9f83fec929edfc4baf661f3c865bdd04d181565b34801561043b57600080fd5b5061024661044a366004612ae9565b610889565b34801561045b57600080fd5b5061024661046a366004612b2b565b61090f565b34801561047b57600080fd5b5061048f61048a366004612ae9565b610a14565b6040516102749190612bf8565b3480156104a857600080fd5b506104bc6104b73660046129d3565b610e62565b604080519586526020860194909452928401919091526060830152608082015260a001610274565b3480156104f057600080fd5b506103ed6104ff366004612a8b565b61102a565b610353610512366004612cd5565b611056565b34801561052357600080fd5b506103ed611140565b34801561053857600080fd5b50610246610547366004612da4565b61114c565b34801561055857600080fd5b506102e2610567366004612dd9565b7fbc197c810000000000000000000000000000000000000000000000000000000098975050505050505050565b3480156105a057600080fd5b506102e26105af366004612e94565b7ff23a6e61000000000000000000000000000000000000000000000000000000009695505050505050565b60006106287fbe27a319efc8734e89e26ba4bc95f5c788584163b959f03fa04e2d7ab4b9a1207fffffffff000000000000000000000000000000000000000000000000000000008416611217565b92915050565b600061062882611275565b33301461067f576040517fe12588940000000000000000000000000000000000000000000000000000000081523360048201523060248201526044015b60405180910390fd5b610688816112d1565b50565b60008061069985858561138c565b50905080156106cb57507f1626ba7e0000000000000000000000000000000000000000000000000000000090506106d1565b50600090505b9392505050565b6000610628826105da565b60008061070886866040516106f992919061287c565b6040518091039020858561138c565b509050801561073a57507f20c13b0b000000000000000000000000000000000000000000000000000000009050610740565b50600090505b949350505050565b333014610789576040517fe1258894000000000000000000000000000000000000000000000000000000008152336004820152306024820152604401610676565b610688816113ca565b3330146107d3576040517fe1258894000000000000000000000000000000000000000000000000000000008152336004820152306024820152604401610676565b60006107de826105da565b73ffffffffffffffffffffffffffffffffffffffff160361084f576040517f1c3812cc0000000000000000000000000000000000000000000000000000000081527fffffffff0000000000000000000000000000000000000000000000000000000082166004820152602401610676565b61068881600061145a565b60006108847fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf85490565b905090565b3330146108ca576040517fe1258894000000000000000000000000000000000000000000000000000000008152336004820152306024820152604401610676565b60006108fd83836040516020016108e29291906130b4565b6040516020818303038152906040528051906020012061151a565b905061090a81848461159f565b505050565b73ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016300361097e576040517f0a57d61d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61098783611727565b6000806109bf8588886040516020016109a2939291906130fc565b60405160208183030381529060405280519060200120858561138c565b9150915081610a00578084846040517f8f4a234f0000000000000000000000000000000000000000000000000000000081526004016106769392919061311f565b610a0b81888861159f565b50505050505050565b606060008267ffffffffffffffff811115610a3157610a31612ca6565b604051908082528060200260200182016040528015610a9157816020015b610a7e604051806080016040528060001515815260200160001515815260200160608152602001600081525090565b815260200190600190039081610a4f5790505b5090508260005b81811015610e585736868683818110610ab357610ab3613139565b9050602002810190610ac59190613168565b90506000816040013590506001858481518110610ae457610ae4613139565b60209081029190910101519015159052805a1015610be6576000858481518110610b1057610b10613139565b6020908102919091018101519115159101527f2bb3e3ba0000000000000000000000000000000000000000000000000000000083825a604051602481019390935260448301919091526064820152608401604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050858481518110610bd057610bd0613139565b6020026020010151604001819052505050610e58565b610bf360208301836131a6565b15610d005760005a9050610c0d6080840160608501612900565b73ffffffffffffffffffffffffffffffffffffffff168215610c2f5782610c31565b5a5b610c3e60a08601866131c1565b604051610c4c92919061287c565b6000604051808303818686f4925050503d8060008114610c88576040519150601f19603f3d011682016040523d82523d6000602084013e610c8d565b606091505b50878681518110610ca057610ca0613139565b6020026020010151602001888781518110610cbd57610cbd613139565b6020026020010151604001829052821515151581525050505a8103868581518110610cea57610cea613139565b6020026020010151606001818152505050610e0c565b60005a9050610d156080840160608501612900565b73ffffffffffffffffffffffffffffffffffffffff1660808401358315610d3c5783610d3e565b5a5b90610d4c60a08701876131c1565b604051610d5a92919061287c565b600060405180830381858888f193505050503d8060008114610d98576040519150601f19603f3d011682016040523d82523d6000602084013e610d9d565b606091505b50878681518110610db057610db0613139565b6020026020010151602001888781518110610dcd57610dcd613139565b6020026020010151604001829052821515151581525050505a8103868581518110610dfa57610dfa613139565b60200260200101516060018181525050505b848381518110610e1e57610e1e613139565b602002602001015160200151158015610e425750610e4260408301602084016131a6565b15610e4e575050610e58565b5050600101610a98565b5090949350505050565b60008060008060008087876000818110610e7e57610e7e613139565b909101357fff00000000000000000000000000000000000000000000000000000000000000169150819050610ed457610eb68961151a565b9250610ec3838989611830565b9298509096509450915061101f9050565b7fff0000000000000000000000000000000000000000000000000000000000000081811601610f1357610f068961151a565b9250610ec3838989611881565b7ffe000000000000000000000000000000000000000000000000000000000000007fff00000000000000000000000000000000000000000000000000000000000000821601610f6557610f06896118ad565b7ffd000000000000000000000000000000000000000000000000000000000000007fff00000000000000000000000000000000000000000000000000000000000000821601610fc957610fb989898961191a565b955095509550955095505061101f565b6040517f6085cd820000000000000000000000000000000000000000000000000000000081527fff0000000000000000000000000000000000000000000000000000000000000082166004820152602401610676565b939792965093509350565b60006106287f8d0bf1fd623d628c741362c1289948e57b3e2905218c676d3e69abee36d6ae2e83611217565b6000333014611099576040517fe1258894000000000000000000000000000000000000000000000000000000008152336004820152306024820152604401610676565b81516020830134f0905073ffffffffffffffffffffffffffffffffffffffff81166110f257816040517f0d2571910000000000000000000000000000000000000000000000000000000081526004016106769190613226565b60405173ffffffffffffffffffffffffffffffffffffffff821681527fa506ad4e7f05eceba62a023c3219e5bd98a615f4fa87e2afb08a2da5cf62bf0c9060200160405180910390a1919050565b6000610884600061102a565b33301461118d576040517fe1258894000000000000000000000000000000000000000000000000000000008152336004820152306024820152604401610676565b6000611198836105da565b73ffffffffffffffffffffffffffffffffffffffff1614611209576040517f5b4d6d6a0000000000000000000000000000000000000000000000000000000081527fffffffff0000000000000000000000000000000000000000000000000000000083166004820152602401610676565b611213828261145a565b5050565b6000808383604051602001611236929190918252602082015260400190565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0818403018152919052805160209091012054949350505050565b60007f6ffbd451000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316016112c857506001919050565b61062882611a97565b73ffffffffffffffffffffffffffffffffffffffff81163b611337576040517f0c76093700000000000000000000000000000000000000000000000000000000815273ffffffffffffffffffffffffffffffffffffffff82166004820152602401610676565b61133f813055565b60405173ffffffffffffffffffffffffffffffffffffffff821681527f310ba5f1d2ed074b51e2eccd052a47ae9ab7c6b800d1fca3db3999d6a592ca03906020015b60405180910390a150565b600080600080600061139f888888610e62565b509650919450925090508282108015906113bd57506113bd81611bd8565b9450505050935093915050565b80611401576040517f4294d12700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b61142a7fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf8829055565b6040518181527f307ed6bd941ee9fc80f369c94af5fa11e25bab5102a6140191756c5474a30bfa90602001611381565b604080517fbe27a319efc8734e89e26ba4bc95f5c788584163b959f03fa04e2d7ab4b9a1206020808301919091527fffffffff000000000000000000000000000000000000000000000000000000008516828401819052835180840385018152606084018086528151919093012073ffffffffffffffffffffffffffffffffffffffff8616908190559152608082015290517f0d7fc113eaf016db4681a1ba86d083ce3e0961f321062a75ac2b0aeb33deeed19181900360a00190a15050565b6040517f190100000000000000000000000000000000000000000000000000000000000060208201524660228201527fffffffffffffffffffffffffffffffffffffffff0000000000000000000000003060601b166042820152605681018290526000906076015b604051602081830303815290604052805190602001209050919050565b8060005b8181101561172057368484838181106115be576115be613139565b90506020028101906115d09190613168565b90506040810135805a10156116255782815a6040517f2bb3e3ba000000000000000000000000000000000000000000000000000000008152600481019390935260248301919091526044820152606401610676565b600061163460208401846131a6565b156116735761166c61164c6080850160608601612900565b8315611658578361165a565b5a5b61166760a08701876131c1565b611be3565b90506116ae565b6116ab6116866080850160608601612900565b608085013584156116975784611699565b5a5b6116a660a08801886131c1565b611bfe565b90505b80156116f357877f5c4eeb02dabf8976016ab414d617f9a162936dcace3cdef8c69ef6e262ad5ae7856040516116e691815260200190565b60405180910390a2611715565b61171561170660408501602086016131a6565b8986611710611c1b565b611c3a565b5050506001016115a3565b5050505050565b606081901c6bffffffffffffffffffffffff821660006117468361102a565b9050818114158015611756575060005b1561179e576040517f9b6514f4000000000000000000000000000000000000000000000000000000008152600481018490526024810183905260448101829052606401610676565b604080517f8d0bf1fd623d628c741362c1289948e57b3e2905218c676d3e69abee36d6ae2e60208083019190915281830186905282518083038401815260609092019092528051910120600183019081905560408051858152602081018390527f1f180c27086c7a39ea2a7b25239d1ab92348f07ca7bb59d1438fcf527568f881910160405180910390a15050505050565b600080808061184b87611846876006818b613239565b611c88565b6000908152873560f01c6020818152604080842084526002909a013560e01c908190529890912090999198509695509350505050565b600080808061189c87611897876001818b613239565b611830565b935093509350935093509350935093565b6040517f190100000000000000000000000000000000000000000000000000000000000060208201526000602282018190527fffffffffffffffffffffffffffffffffffffffff0000000000000000000000003060601b1660428301526056820183905290607601611582565b6000808080806004600188013560e81c826119358383613292565b90506119478b6104b783868d8f613239565b939b509199509750955093508787101561199f5761196781848b8d613239565b89896040517fb006aba000000000000000000000000000000000000000000000000000000000815260040161067694939291906132a5565b8092505b88831015611a895760038301928a013560e81c91506119c28383613292565b905060006119e46119d28861211e565b8c8c879086926104b793929190613239565b939c50919a5098509091505088881015611a3c57611a0482858c8e613239565b8a8a6040517fb006aba000000000000000000000000000000000000000000000000000000000815260040161067694939291906132a5565b848110611a7f576040517f37daf62b0000000000000000000000000000000000000000000000000000000081526004810182905260248101869052604401610676565b93509150816119a3565b505050939792965093509350565b60007fffffffff0000000000000000000000000000000000000000000000000000000082167fec6aba50000000000000000000000000000000000000000000000000000000001480611b2a57507fffffffff0000000000000000000000000000000000000000000000000000000082167f4e2312e000000000000000000000000000000000000000000000000000000000145b80611b7657507fffffffff0000000000000000000000000000000000000000000000000000000082167f150b7a0200000000000000000000000000000000000000000000000000000000145b80611bc257507fffffffff0000000000000000000000000000000000000000000000000000000082167fc0ee0b8a00000000000000000000000000000000000000000000000000000000145b15611bcf57506001919050565b61062882612152565b6000610628826121ae565b60006040518284823760008084838989f49695505050505050565b6000604051828482376000808483898b8af1979650505050505050565b60603d604051915060208201818101604052818352816000823e505090565b8315611c4857805160208201fd5b827fab46c69f7f32e1bf09b0725853da82a211e5402a0600296ab499a2fb5ea3b4198383604051611c7a9291906132cc565b60405180910390a250505050565b60008060005b8381101561211557600181019085013560f81c7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8101611d2f57601582019186013560f881901c9060581c73ffffffffffffffffffffffffffffffffffffffff81169074ff000000000000000000000000000000000000000016811785611d155780611d24565b60008681526020829052604090205b955050505050611c8e565b80611dc55760018201918681013560f81c906043016000611d5b8a611d5684888c8e613239565b6121c7565b60ff841697909701969194508491905060a083901b74ff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff82161786611daa5780611db9565b60008781526020829052604090205b96505050505050611c8e565b60028103611eed576000808784013560f881901c9060581c73ffffffffffffffffffffffffffffffffffffffff16601586019550909250905060008885013560e81c600386018162ffffff169150809650819250505060008186019050611e3e8b848c8c8a908692611e3993929190613239565b61248a565b611e86578a83611e5083898d8f613239565b6040517f9a94623200000000000000000000000000000000000000000000000000000000815260040161067694939291906132e5565b60ff8416979097019694508460a084901b74ff00000000000000000000000000000000000000001673ffffffffffffffffffffffffffffffffffffffff84161787611ed15780611ee0565b60008881526020829052604090205b9750505050505050611c8e565b60038103611f2057602082019186013583611f085780611f17565b60008481526020829052604090205b93505050611c8e565b60048103611f6c576003808301928781013560e81c9190820101600080611f4d8b61184685898d8f613239565b60009889526020526040909720969097019650909350611c8e92505050565b600681036120745760008287013560f81c60018401935060ff16905060008784013560f01c60028501945061ffff16905060008885013560e81c600386018162ffffff169150809650819250505060008186019050600080611fda8d8d8d8b90879261184693929190613239565b93985088939092509050848210611ff057988501985b604080517f53657175656e6365206e657374656420636f6e6669673a0a0000000000000000602080830191909152603882018490526058820188905260788083018a90528351808403909101815260989092019092528051910120896120565780612065565b60008a81526020829052604090205b99505050505050505050611c8e565b600581036120e05760208201918601358781036120af577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff94505b60006120ba82612671565b9050846120c757806120d6565b60008581526020829052604090205b9450505050611c8e565b6040517fb2505f7c00000000000000000000000000000000000000000000000000000000815260048101829052602401610676565b50935093915050565b7f8713a7c4465f6fbee2b6e9d6646d1d9f83fec929edfc4baf661f3c865bdd04d16000908152602082905260408120610628565b60007ffda4dd44000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316016121a557506001919050565b610628826126ac565b60006121b982612708565b806106285750600192915050565b6000604282146122075782826040517f2ee17a3d000000000000000000000000000000000000000000000000000000008152600401610676929190613325565b6000612220612217600185613339565b85013560f81c90565b60ff169050604084013560f81c843560208601357f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0811115612294578686826040517fad4aac760000000000000000000000000000000000000000000000000000000081526004016106769392919061334c565b8260ff16601b141580156122ac57508260ff16601c14155b156122e9578686846040517fe578897e00000000000000000000000000000000000000000000000000000000815260040161067693929190613370565b60018403612356576040805160008152602081018083528a905260ff851691810191909152606081018390526080810182905260019060a0015b6020604051602081039080840390855afa158015612345573d6000803e3d6000fd5b50505060206040510351945061242e565b600284036123f3576040517f19457468657265756d205369676e6564204d6573736167653a0a3332000000006020820152603c8101899052600190605c01604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181528282528051602091820120600084529083018083525260ff861690820152606081018490526080810183905260a001612323565b86868560016040517f9dfba8520000000000000000000000000000000000000000000000000000000081526004016106769493929190613397565b73ffffffffffffffffffffffffffffffffffffffff851661247f5786866040517f6c1719d2000000000000000000000000000000000000000000000000000000008152600401610676929190613325565b505050509392505050565b60008181036124c5576040517fac241e1100000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b600083836124d4600182613339565b8181106124e3576124e3613139565b919091013560f81c91505060018114806124fd5750600281145b15612542578473ffffffffffffffffffffffffffffffffffffffff166125248786866121c7565b73ffffffffffffffffffffffffffffffffffffffff16149150612668565b6003810361262d5773ffffffffffffffffffffffffffffffffffffffff8516631626ba7e8786600087612576600182613339565b9261258393929190613239565b6040518463ffffffff1660e01b81526004016125a19392919061311f565b602060405180830381865afa1580156125be573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906125e291906133c3565b7fffffffff00000000000000000000000000000000000000000000000000000000167f1626ba7e00000000000000000000000000000000000000000000000000000000149150612668565b83838260006040517f9dfba8520000000000000000000000000000000000000000000000000000000081526004016106769493929190613397565b50949350505050565b6040517f53657175656e636520737461746963206469676573743a0a0000000000000000602082015260388101829052600090605801611582565b60007fe4a77bbc000000000000000000000000000000000000000000000000000000007fffffffff000000000000000000000000000000000000000000000000000000008316016126ff57506001919050565b6106288261273b565b600081158015906106285750507fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf8541490565b60007fae9fa280000000000000000000000000000000000000000000000000000000007fffffffff0000000000000000000000000000000000000000000000000000000083160161278e57506001919050565b6106288260007fffffffff0000000000000000000000000000000000000000000000000000000082167fac6a444e00000000000000000000000000000000000000000000000000000000148061282557507fffffffff0000000000000000000000000000000000000000000000000000000082167f36e7817500000000000000000000000000000000000000000000000000000000145b1561283257506001919050565b7f01ffc9a7000000000000000000000000000000000000000000000000000000007fffffffff00000000000000000000000000000000000000000000000000000000831614610628565b8183823760009101908152919050565b7fffffffff000000000000000000000000000000000000000000000000000000008116811461068857600080fd5b6000602082840312156128cc57600080fd5b81356106d18161288c565b803573ffffffffffffffffffffffffffffffffffffffff811681146128fb57600080fd5b919050565b60006020828403121561291257600080fd5b6106d1826128d7565b60008083601f84011261292d57600080fd5b50813567ffffffffffffffff81111561294557600080fd5b60208301915083602082850101111561295d57600080fd5b9250929050565b60008060008060006080868803121561297c57600080fd5b612985866128d7565b9450612993602087016128d7565b935060408601359250606086013567ffffffffffffffff8111156129b657600080fd5b6129c28882890161291b565b969995985093965092949392505050565b6000806000604084860312156129e857600080fd5b83359250602084013567ffffffffffffffff811115612a0657600080fd5b612a128682870161291b565b9497909650939450505050565b60008060008060408587031215612a3557600080fd5b843567ffffffffffffffff80821115612a4d57600080fd5b612a598883890161291b565b90965094506020870135915080821115612a7257600080fd5b50612a7f8782880161291b565b95989497509550505050565b600060208284031215612a9d57600080fd5b5035919050565b60008083601f840112612ab657600080fd5b50813567ffffffffffffffff811115612ace57600080fd5b6020830191508360208260051b850101111561295d57600080fd5b60008060208385031215612afc57600080fd5b823567ffffffffffffffff811115612b1357600080fd5b612b1f85828601612aa4565b90969095509350505050565b600080600080600060608688031215612b4357600080fd5b853567ffffffffffffffff80821115612b5b57600080fd5b612b6789838a01612aa4565b9097509550602088013594506040880135915080821115612b8757600080fd5b506129c28882890161291b565b6000815180845260005b81811015612bba57602081850181015186830182015201612b9e565b5060006020828601015260207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011685010191505092915050565b60006020808301818452808551808352604092508286019150828160051b87010184880160005b83811015612c98577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc08984030185528151608081511515855288820151151589860152878201518189870152612c7782870182612b94565b60609384015196909301959095525094870194925090860190600101612c1f565b509098975050505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600060208284031215612ce757600080fd5b813567ffffffffffffffff80821115612cff57600080fd5b818401915084601f830112612d1357600080fd5b813581811115612d2557612d25612ca6565b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0908116603f01168101908382118183101715612d6b57612d6b612ca6565b81604052828152876020848701011115612d8457600080fd5b826020860160208301376000928101602001929092525095945050505050565b60008060408385031215612db757600080fd5b8235612dc28161288c565b9150612dd0602084016128d7565b90509250929050565b60008060008060008060008060a0898b031215612df557600080fd5b612dfe896128d7565b9750612e0c60208a016128d7565b9650604089013567ffffffffffffffff80821115612e2957600080fd5b612e358c838d01612aa4565b909850965060608b0135915080821115612e4e57600080fd5b612e5a8c838d01612aa4565b909650945060808b0135915080821115612e7357600080fd5b50612e808b828c0161291b565b999c989b5096995094979396929594505050565b60008060008060008060a08789031215612ead57600080fd5b612eb6876128d7565b9550612ec4602088016128d7565b94506040870135935060608701359250608087013567ffffffffffffffff811115612eee57600080fd5b612efa89828a0161291b565b979a9699509497509295939492505050565b803580151581146128fb57600080fd5b8183528181602085013750600060208284010152600060207fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f840116840101905092915050565b81835260006020808501808196508560051b810191508460005b878110156130a757828403895281357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff41883603018112612fbe57600080fd5b870160c0612fcb82612f0c565b15158652612fda878301612f0c565b15158688015260408281013590870152606073ffffffffffffffffffffffffffffffffffffffff61300c8285016128d7565b16908701526080828101359087015260a080830135368490037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe101811261305257600080fd5b90920187810192903567ffffffffffffffff81111561307057600080fd5b80360384131561307f57600080fd5b82828901526130918389018286612f1c565b9c89019c97505050928601925050600101612f7f565b5091979650505050505050565b60408152600560408201527f73656c663a0000000000000000000000000000000000000000000000000000006060820152608060208201526000610740608083018486612f65565b838152604060208201526000613116604083018486612f65565b95945050505050565b838152604060208201526000613116604083018486612f1c565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff4183360301811261319c57600080fd5b9190910192915050565b6000602082840312156131b857600080fd5b6106d182612f0c565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe18436030181126131f657600080fd5b83018035915067ffffffffffffffff82111561321157600080fd5b60200191503681900382131561295d57600080fd5b6020815260006106d16020830184612b94565b6000808585111561324957600080fd5b8386111561325657600080fd5b5050820193919092039150565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b8082018082111561062857610628613263565b6060815260006132b9606083018688612f1c565b6020830194909452506040015292915050565b8281526040602082015260006107406040830184612b94565b84815273ffffffffffffffffffffffffffffffffffffffff8416602082015260606040820152600061331b606083018486612f1c565b9695505050505050565b602081526000610740602083018486612f1c565b8181038181111561062857610628613263565b604081526000613360604083018587612f1c565b9050826020830152949350505050565b604081526000613384604083018587612f1c565b905060ff83166020830152949350505050565b6060815260006133ab606083018688612f1c565b60208301949094525090151560409091015292915050565b6000602082840312156133d557600080fd5b81516106d18161288c56fea2646970667358221220208dca6e3da934cffa05fe425bd9f9c5ea850f85d9181867d2f8c6b2c736fa6564736f6c63430008120033'
